From 8bd5286bb7a0f3dd3960c7f8ee6c12f7a5c771d1 Mon Sep 17 00:00:00 2001
From: Marek Majkowski <marek@cloudflare.com>
Date: Sun, 1 Dec 2019 14:32:50 +0100
Subject: [PATCH] Feature: Draw cross on the automap denoting other players.

Useful in coop multiplayer. For pvp don't draw it.
---
 Source/automap.cpp | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/Source/automap.cpp b/Source/automap.cpp
index fae2c070..68dbf7c8 100644
--- a/Source/automap.cpp
+++ b/Source/automap.cpp
@@ -433,6 +433,8 @@ void DrawAutomapTile(int sx, int sy, WORD automap_type)
 
 void DrawAutomapPlr()
 {
+        int plrno;
+
 	int px, py;
 	int x, y;
 
@@ -459,6 +461,38 @@ void DrawAutomapPlr()
 		x += 160;
 	y -= AmLine8;
 
+        // MM
+        {
+                int plrno;
+                for (plrno = 0; plrno < MAX_PLRS; plrno++) {
+                        if (currlevel != plr[plrno].plrlevel) {
+                                continue;
+                        }
+                        int x = plr[plrno].WorldX;
+                        int y = plr[plrno].WorldY;
+                        int px = x - 2 * AutoMapXOfs - ViewX;
+                        int py = y - 2 * AutoMapYOfs - ViewY;
+
+                        x = (plr[plrno]._pxoff * AutoMapScale / 100 >> 1) + (ScrollInfo._sxoff * AutoMapScale / 100 >> 1) + (px - py) * AmLine16 + 384;
+                        y = (plr[plrno]._pyoff * AutoMapScale / 100 >> 1) + (ScrollInfo._syoff * AutoMapScale / 100 >> 1) + (px + py) * AmLine8 + 336;
+
+                        if (invflag || sbookflag)
+                                x -= 160;
+                        if (chrflag || questlog)
+                                x += 160;
+                        y -= AmLine8;
+
+                        if (plrno != myplr) {
+                                /* Draw cross for other players in game */
+                                int t = AmLine16 / 6;
+                                int l = AmLine16 / 4;
+
+                                DrawLine(x-l, y-t, x + l, y + l, COLOR_PLAYER);
+                                DrawLine(x-l, y+l, x + l, y - t, COLOR_PLAYER);
+                        }
+                }
+        }
+
 	switch (plr[myplr]._pdir) {
 	case DIR_N:
 		DrawLine(x, y, x, y - AmLine16, COLOR_PLAYER);
-- 
2.26.2

